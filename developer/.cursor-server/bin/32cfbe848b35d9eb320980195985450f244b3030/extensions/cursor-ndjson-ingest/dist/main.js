(()=>{"use strict";var e={184:function(e,t,r){var o,n=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),i=0;i<r.length;i++)"default"!==r[i]&&n(t,e,r[i]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.activate=async function(e){l.NdjsonIngestLogger.init(),e.subscriptions.push(a.commands.registerCommand("cursor.ndjsonIngest.start",()=>async function(e){if(!a.workspace.isTrusted)return void a.window.showWarningMessage("debug mode disabled in untrusted workspace.");const t=a.workspace.workspaceFolders?.[0];if(!t)return void a.window.showErrorMessage("No workspace storage available (open a folder/workspace).");if(p)return{externalUrl:h,logPath:w};const r=a.workspace.getConfiguration("ndjson"),o=r.get("relativeLogFile",".cursor/debug.log"),n=a.Uri.joinPath(t.uri,o);d.mkdirSync((0,u.dirname)(n.fsPath),{recursive:!0}),w=n.fsPath;const s=e.workspaceState.get("nrdjson.targetId",crypto.randomUUID());e.workspaceState.update("nrdjson.targetId",s),p=c.createServer((e,t)=>(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),"OPTIONS"===e.method?(t.writeHead(200),void t.end()):"POST"!==e.method||e.url!==`/ingest/${s}`?(t.writeHead(404),void t.end()):void async function(e,t){const r=()=>new Promise((r,o)=>{const n=d.createWriteStream(t,{flags:"a"});(0,g.pipeline)(e,function(){let e=10;return new g.Transform({transform(t,r,o){e=t[t.length-1],o(null,t)},flush(t){10!==e&&this.push(Buffer.from("\n")),t()}})}(),n,e=>{e?o(e):r()})}),o=N.then(r,r);return N=o.catch(e=>{l.NdjsonIngestLogger.error("Error appending to log file:",e)}),o}(e,w).then(()=>{t.writeHead(204),t.end()}).catch(e=>{l.NdjsonIngestLogger.error("NDJSON ingest write error:",e),t.writeHead(500),t.end("write-failed")})));const i=r.get("bindAddress","127.0.0.1"),S=0===r.get("port",0);let j,O;try{j=await async function(e,t){const r=a.workspace.getConfiguration("ndjson").get("port",0);if(0!==r)return r;const o=e.workspaceState.get("allocatedPort",0);if(0!==o)return o;const n=e.globalState.get("lastAllocatedPort",m-1),s=v-m+1;for(let r=0;r<s;r++){const o=m+(n-m+1+r)%s;if(await b(o,t))return await e.globalState.update("lastAllocatedPort",o),await e.workspaceState.update("allocatedPort",o),l.NdjsonIngestLogger.info(`Auto-allocated port ${o} and saved to internal storage`),o}throw new Error(`No available ports in range ${m}-${v}`)}(e,i)}catch(e){const t=e instanceof Error?e.message:String(e);return l.NdjsonIngestLogger.error("Failed to choose port:",e),a.window.showErrorMessage(`NDJSON Ingest: ${t}`),t}const P=new Promise(e=>O=e);return p.once("error",e=>{switch(e.code){case"EADDRINUSE":l.NdjsonIngestLogger.error(`Port ${j} is already in use`),S?a.window.showErrorMessage(`NDJSON Ingest: Cannot start server - port ${j} became unavailable. Please try again.`):a.window.showErrorMessage(`NDJSON Ingest: Cannot start server - port ${j} is already in use. Try changing the port in settings or stopping the other service.`,"Change Port").then(e=>{"Change Port"===e&&a.commands.executeCommand("workbench.action.openWorkspaceSettings","ndjson.port")}),O("Port is already in use");break;case"EACCES":l.NdjsonIngestLogger.error(`Permission denied for port ${j}`),S?a.window.showErrorMessage(`NDJSON Ingest: Permission denied for port ${j}. This is unexpected for auto-allocated ports.`):a.window.showErrorMessage(`NDJSON Ingest: Permission denied for port ${j}. Try using a port number greater than 1024.`,"Change Port").then(e=>{"Change Port"===e&&a.commands.executeCommand("workbench.action.openWorkspaceSettings","ndjson.port")}),O(`Permission denied for port ${j}`);break;default:l.NdjsonIngestLogger.error("NDJSON ingest server listen error:",e),a.window.showErrorMessage(`NDJSON Ingest: Server error - ${e.message}`),O(`Server error - ${e.message}`)}p=void 0}),p.listen(j,i,async()=>{const e=p.address();f="object"==typeof e&&e?e.port:0;const t=a.Uri.parse(`http://${i}:${f}/ingest/${s}`);try{const e=await a.env.asExternalUri(t);h=e.toString()}catch(e){l.NdjsonIngestLogger.error("asExternalUri failed; using loopback URL",e),h=t.toString()}try{d.existsSync(w)&&d.unlinkSync(w)}catch(e){l.NdjsonIngestLogger.error("Error clearing existing log file:",e)}l.NdjsonIngestLogger.info(`NDJSON ingest server started on port ${f}`),O({externalUrl:h,logPath:w})}),P}(e))),e.subscriptions.push(a.commands.registerCommand("cursor.ndjsonIngest.stop",()=>S())),e.subscriptions.push(a.commands.registerCommand("cursor.ndjsonIngest.copyCurl",async()=>{if(!h)return void a.window.showWarningMessage("Server is not running.");const e=`curl -sS -H "Content-Type: application/x-ndjson" --data-binary '{"hello":"world"}' "${h.toString()}"`;await a.env.clipboard.writeText(e),a.window.showInformationMessage("NDJSON Ingest: curl command copied to clipboard.")})),e.subscriptions.push(a.commands.registerCommand("cursor.ndjsonIngest.showStatus",()=>{h?a.window.showInformationMessage(`URL: ${h.toString()}`):a.window.showInformationMessage("NDJSON: server not running.")}))},t.deactivate=async function(){await S()};const a=i(r(398)),c=i(r(611)),d=i(r(896)),u=r(928),g=r(203),l=r(377);let p,f=0,w="",h="";const m=7242,v=7942;function b(e,t){return new Promise(r=>{const o=c.createServer();o.once("error",()=>r(!1)),o.once("listening",()=>{o.close(()=>r(!0))}),o.listen(e,t)})}let N=Promise.resolve();async function S(){l.NdjsonIngestLogger.info("Stopping NDJSON ingest server"),p&&(await new Promise(e=>p.close(()=>e())).catch(e=>{l.NdjsonIngestLogger.error("Error stopping NDJSON ingest server:",e)}),p=void 0)}},203:e=>{e.exports=require("stream")},377:function(e,t,r){var o,n=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),i=0;i<r.length;i++)"default"!==r[i]&&n(t,e,r[i]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.NdjsonIngestLogger=void 0;const a=i(r(398));class c{static init(){c.output=a.window.createOutputChannel("NDJSON Ingest",{log:!0})}static error(e,...t){c.output||c.init(),c.output?.error(e,...t)}static warn(e,...t){c.output||c.init(),c.output?.warn(e,...t)}static info(e,...t){c.output||c.init(),c.output?.info(e,...t)}static debug(e,...t){c.output||c.init(),c.output?.debug(e,...t)}static trace(e,...t){c.output||c.init(),c.output?.trace(e,...t)}}t.NdjsonIngestLogger=c},398:e=>{e.exports=require("vscode")},611:e=>{e.exports=require("http")},896:e=>{e.exports=require("fs")},928:e=>{e.exports=require("path")}},t={},r=function r(o){var n=t[o];if(void 0!==n)return n.exports;var s=t[o]={exports:{}};return e[o].call(s.exports,s,s.exports,r),s.exports}(184),o=exports;for(var n in r)o[n]=r[n];r.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})})();
//# sourceMappingURL=http://go/sourcemap/sourcemaps/32cfbe848b35d9eb320980195985450f244b3030/extensions/cursor-ndjson-ingest/dist/main.js.map